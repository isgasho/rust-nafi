language: rust
sudo: required
conditions: v1

# https://levans.fr/rust_travis_cache.html
cache:
  directories:
    - /home/travis/.cargo
before_cache:
  - rm -rf /home/travis/.cargo/registry

stages:
  - name: test
  - name: deploy
    if: branch=master AND type=push

branches:
  only:
  - staging
  - trying
  - master

matrix:
  fast_finish: true
  allow_failures:
    - rust: nightly
    - install:
      - cargo install cargo-tarpaulin

  include:
    - name: tests
      rust: beta
      script:
        - cargo test --all
        - cargo doc --all --no-deps

    - name: style
      rust: beta-2018-10-13
      install:
        - rustup component add rustfmt-preview
        - rustup component add clippy-preview
      script:
        - cargo clippy --all-targets --tests -- -D warnings
        - cargo fmt -- --check

    - name: coverage
      rust: nightly
      env:
        - RUSTFLAGS=--cfg procmacro2_semver_exempt
      addons:
        apt:
          packages:
            - libssl-dev
      install:
        - cargo install cargo-tarpaulin
      after_success: -|
        cargo tarpaulin --out Xml
        bash <(curl -s https://codecov.io/bash)

    - stage: deploy
      script: cargo doc --all --no-deps
      deploy:
        provider: pages
        skip-cleanup: true
        local-dir: "target/doc"
        github-token: $GH_TOKEN

script:
  - cargo test --all
  - cargo doc --all --no-deps
