language: rust
cache: cargo
conditions: v1

stages:
- name: test
- name: warnings
- name: deploy
  if: branch=master AND type=push

rust:
- beta

branches:
  only:
  - staging
  - trying
  - master

script:
- cargo build --all
- cargo test  --all

matrix:
  include:
  
  # clippy and rustfmt
  - stage: warnings
    rust: nightly-2018-07-15
    install:
    - rustup component add rustfmt-preview
    - rustup component add clippy-preview
    script:
    - cargo clippy --all-targets --tests -- -D clippy -D warnings
    - cargo fmt -- --check

  # master docs on GitHub Pages
  - stage: deploy
    if: tag=false
    script: cargo doc --all --no-deps
    deploy:
      provider: pages
      skip-cleanup: true
      local-dir: "target/doc"
      github-token: $GH_TOKEN
